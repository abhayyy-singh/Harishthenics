<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Access Your Course — Haristhenics</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Geist:wght@300;400;500;600&display=swap" rel="stylesheet">
    <style>
        *, *::before, *::after {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg: #000000;
            --surface: #0a0a0a;
            --border: rgba(255,255,255,0.1);
            --border-hover: rgba(255,255,255,0.25);
            --text: #ededed;
            --text-muted: rgba(255,255,255,0.5);
            --text-subtle: rgba(255,255,255,0.3);
            --accent: #7C9CB5;
            --accent-hover: #A3C1D8;
            --btn-bg: rgba(255,255,255,0.06);
            --btn-hover: rgba(255,255,255,0.1);
            --radius: 8px;
            --font: 'Geist', -apple-system, BlinkMacSystemFont, sans-serif;
        }

        html, body {
            height: 100%;
            background: var(--bg);
            color: var(--text);
            font-family: var(--font);
            font-size: 14px;
            -webkit-font-smoothing: antialiased;
        }

        body {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 24px;
        }

        /* Top logo */
        .logo {
            position: fixed;
            top: 24px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            align-items: center;
            gap: 8px;
            text-decoration: none;
            color: var(--text);
        }

        .logo__mark {
            width: 24px;
            height: 24px;
            background: var(--accent);
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: 600;
            color: #fff;
            letter-spacing: -0.5px;
        }

        .logo__text {
            font-size: 15px;
            font-weight: 500;
            letter-spacing: -0.3px;
        }

        /* Card */
        .card {
            width: 100%;
            max-width: 400px;
            animation: fadeUp 0.4s ease forwards;
            opacity: 0;
        }

        @keyframes fadeUp {
            from { opacity: 0; transform: translateY(12px); }
            to   { opacity: 1; transform: translateY(0); }
        }

        .card__header {
            text-align: center;
            margin-bottom: 32px;
        }

        .card__title {
            font-size: 24px;
            font-weight: 600;
            letter-spacing: -0.6px;
            color: var(--text);
            margin-bottom: 8px;
            line-height: 1.2;
        }

        .card__subtitle {
            font-size: 14px;
            color: var(--text-muted);
            line-height: 1.5;
        }

        /* Token badge */
        .token-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            background: rgba(124,156,181,0.1);
            border: 1px solid rgba(124,156,181,0.25);
            border-radius: 20px;
            padding: 4px 12px;
            font-size: 12px;
            color: var(--accent);
            margin-bottom: 20px;
            font-weight: 500;
        }

        .token-badge__dot {
            width: 6px;
            height: 6px;
            background: var(--accent);
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.4; }
        }

        /* Email form */
        .email-group {
            margin-bottom: 12px;
        }

        .input {
            width: 100%;
            padding: 10px 14px;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            color: var(--text);
            font-family: var(--font);
            font-size: 14px;
            outline: none;
            transition: border-color 0.2s;
        }

        .input::placeholder {
            color: var(--text-subtle);
        }

        .input:focus {
            border-color: var(--border-hover);
        }

        /* Buttons */
        .btn {
            width: 100%;
            padding: 10px 16px;
            border-radius: var(--radius);
            font-family: var(--font);
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            border: none;
            transition: all 0.15s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            text-decoration: none;
            letter-spacing: -0.1px;
        }

        .btn--primary {
            background: var(--text);
            color: #000;
        }

        .btn--primary:hover {
            background: rgba(255,255,255,0.9);
        }

        .btn--social {
            background: var(--btn-bg);
            color: var(--text);
            border: 1px solid var(--border);
        }

        .btn--social:hover {
            background: var(--btn-hover);
            border-color: var(--border-hover);
        }

        .btn--social:active {
            transform: scale(0.99);
        }

        .btn--social.disabled {
            opacity: 0.4;
            cursor: not-allowed;
            pointer-events: none;
        }

        /* Divider */
        .divider {
            display: flex;
            align-items: center;
            gap: 12px;
            margin: 16px 0;
            color: var(--text-subtle);
            font-size: 12px;
        }

        .divider::before,
        .divider::after {
            content: '';
            flex: 1;
            height: 1px;
            background: var(--border);
        }

        /* Social stack */
        .social-stack {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        /* Icons */
        .icon {
            width: 18px;
            height: 18px;
            flex-shrink: 0;
        }

        /* Footer */
        .card__footer {
            margin-top: 28px;
            text-align: center;
            font-size: 12px;
            color: var(--text-subtle);
            line-height: 1.6;
        }

        .card__footer a {
            color: var(--text-muted);
            text-decoration: none;
            transition: color 0.15s;
        }

        .card__footer a:hover {
            color: var(--text);
        }

        /* Loading state */
        .btn.loading {
            opacity: 0.6;
            pointer-events: none;
        }

        .btn.loading::after {
            content: '';
            width: 14px;
            height: 14px;
            border: 2px solid rgba(0,0,0,0.3);
            border-top-color: #000;
            border-radius: 50%;
            animation: spin 0.6s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Error / Success states */
        .alert {
            padding: 10px 14px;
            border-radius: var(--radius);
            font-size: 13px;
            margin-bottom: 16px;
            display: none;
            align-items: center;
            gap: 8px;
        }

        .alert.show {
            display: flex;
        }

        .alert--error {
            background: rgba(255,80,80,0.08);
            border: 1px solid rgba(255,80,80,0.2);
            color: #ff6b6b;
        }

        .alert--success {
            background: rgba(124,156,181,0.08);
            border: 1px solid rgba(124,156,181,0.2);
            color: var(--accent);
        }

        /* Top nav */
        .topnav {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 64px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 24px;
            border-bottom: 1px solid var(--border);
        }

        .topnav__logo {
            display: flex;
            align-items: center;
            gap: 8px;
            text-decoration: none;
            color: var(--text);
        }

        .topnav__right {
            font-size: 13px;
            color: var(--text-muted);
        }

        .topnav__right a {
            color: var(--text);
            text-decoration: none;
            font-weight: 500;
            transition: color 0.15s;
        }

        .topnav__right a:hover {
            color: var(--accent);
        }

        @media (max-width: 480px) {
            .card__title { font-size: 20px; }
            body { padding: 16px; }
        }
    </style>
</head>
<body>

    <!-- Top Nav -->
    <nav class="topnav">
        <a href="../index.html" class="topnav__logo">
            <div class="logo__mark">H.</div>
            <span class="logo__text">Haristhenics</span>
        </a>
        <div class="topnav__right">
            Need help? <a href="mailto:haristhenics06@gmail.com">Contact us</a>
        </div>
    </nav>

    <!-- Main Card -->
    <div class="card">

        <div class="card__header">
            <!-- Token badge — shown when valid token in URL -->
            <div class="token-badge" id="tokenBadge" style="display:none;">
                <div class="token-badge__dot"></div>
                <span id="tokenCourseName">Knee Pain Program</span>
            </div>

            <h1 class="card__title" id="cardTitle">Access Your Course</h1>
            <p class="card__subtitle" id="cardSubtitle">
                Sign in to unlock your purchased program and start training.
            </p>
        </div>

        <!-- Alert -->
        <div class="alert alert--error" id="alertError">
            <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/>
            </svg>
            <span id="alertErrorText">Something went wrong.</span>
        </div>

        <div class="alert alert--success" id="alertSuccess">
            <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="20 6 9 17 4 12"/>
            </svg>
            <span id="alertSuccessText">Course unlocked! Redirecting...</span>
        </div>

        <!-- Email form -->
        <div class="email-group">
            <input type="email" class="input" id="emailInput" placeholder="Email Address" autocomplete="email">
        </div>
        <button class="btn btn--primary" id="emailBtn" onclick="handleEmailContinue()">
            Continue with Email
        </button>

        <div class="divider">or</div>

        <!-- Social Buttons -->
        <div class="social-stack">

            <!-- Google — ACTIVE -->
            <button class="btn btn--social" id="googleBtn" onclick="handleGoogleLogin()">
                <svg class="icon" viewBox="0 0 24 24">
                    <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                    <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                    <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                    <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                </svg>
                Continue with Google
            </button>

            <!-- Apple — UI READY, commented out until setup -->
            <!--
            <button class="btn btn--social disabled" onclick="return false;">
                <svg class="icon" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M18.71 19.5c-.83 1.24-1.71 2.45-3.05 2.47-1.34.03-1.77-.79-3.29-.79-1.53 0-2 .77-3.27.82-1.31.05-2.3-1.32-3.14-2.53C4.25 17 2.94 12.45 4.7 9.39c.87-1.52 2.43-2.48 4.12-2.51 1.28-.02 2.5.87 3.29.87.78 0 2.26-1.07 3.8-.91.65.03 2.47.26 3.64 1.98-.09.06-2.17 1.28-2.15 3.81.03 3.02 2.65 4.03 2.68 4.04-.03.07-.42 1.44-1.38 2.83M13 3.5c.73-.83 1.94-1.46 2.94-1.5.13 1.17-.34 2.35-1.04 3.19-.69.85-1.83 1.51-2.95 1.42-.15-1.15.41-2.35 1.05-3.11z"/>
                </svg>
                Continue with Apple
            </button>
            -->

            <!-- X / Twitter — UI READY, commented out until setup -->
            <!--
            <button class="btn btn--social disabled" onclick="return false;">
                <svg class="icon" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-4.714-6.231-5.401 6.231H2.744l7.73-8.835L1.254 2.25H8.08l4.253 5.622 5.91-5.622zm-1.161 17.52h1.833L7.084 4.126H5.117z"/>
                </svg>
                Continue with X
            </button>
            -->

        </div>

        <div class="card__footer">
            By continuing, you agree to our
            <a href="../terms.html">Terms of Service</a>
            and
            <a href="../privacy.html">Privacy Policy</a>
            <br><br>
            <a href="../index.html">← Back to Haristhenics</a>
        </div>

    </div>

    <!-- Firebase -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBr9Lga7_vPihQ0siiJ0_c58KkGgrrYVCM",
            authDomain: "workshop-gng.firebaseapp.com",
            projectId: "workshop-gng",
            storageBucket: "workshop-gng.firebasestorage.app",
            messagingSenderId: "304234238485",
            appId: "1:304234238485:web:040417be6f6a7cb35ef41c"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();

        // Get token from URL
        const urlParams = new URLSearchParams(window.location.search);
        const token = urlParams.get('token');
        const courseId = urlParams.get('course');

        // ==========================================
        // SHOW TOKEN BADGE IF VALID TOKEN IN URL
        // ==========================================
        if (token) {
            document.getElementById('tokenBadge').style.display = 'inline-flex';
            document.getElementById('cardTitle').textContent = 'Unlock Your Course';
            document.getElementById('cardSubtitle').textContent = 'Sign in with the email used during purchase to access your program.';
            
            // Fetch token details
            getDoc(doc(db, 'claims', token)).then(snap => {
                if (snap.exists()) {
                    const data = snap.data();
                    if (data.courseName) {
                        document.getElementById('tokenCourseName').textContent = data.courseName;
                    }
                }
            }).catch(() => {});
        }

        // ==========================================
        // AUTH STATE — Already logged in?
        // ==========================================
        onAuthStateChanged(auth, async (user) => {
            if (user && token) {
                await claimCourse(user, token);
            } else if (user && !token) {
                // Already logged in, no token — go to home
                window.location.href = '../index.html';
            }
        });

        // ==========================================
        // GOOGLE LOGIN
        // ==========================================
        window.handleGoogleLogin = async function() {
            const btn = document.getElementById('googleBtn');
            btn.classList.add('loading');
            btn.textContent = '';

            try {
                const result = await signInWithPopup(auth, provider);
                const user = result.user;

                // Save user to Firestore
                await setDoc(doc(db, 'users', user.uid), {
                    name: user.displayName,
                    email: user.email,
                    photo: user.photoURL,
                    lastLogin: new Date().toISOString()
                }, { merge: true });

                if (token) {
                    await claimCourse(user, token);
                } else {
                    window.location.href = '../index.html';
                }

            } catch (err) {
                btn.classList.remove('loading');
                btn.innerHTML = `<svg class="icon" viewBox="0 0 24 24"><path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/><path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/><path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg> Continue with Google`;
                showError(err.code === 'auth/popup-closed-by-user' ? 'Login cancelled.' : 'Login failed. Please try again.');
            }
        };

        // ==========================================
        // EMAIL CONTINUE (placeholder - future)
        // ==========================================
        window.handleEmailContinue = function() {
            const email = document.getElementById('emailInput').value.trim();
            if (!email) {
                document.getElementById('emailInput').focus();
                return;
            }
            showError('Email login coming soon. Please use Google to continue.');
        };

        // ==========================================
        // CLAIM COURSE
        // ==========================================
        async function claimCourse(user, token) {
            try {
                const claimRef = doc(db, 'claims', token);
                const claimSnap = await getDoc(claimRef);

                if (!claimSnap.exists()) {
                    showError('Invalid or expired link. Please contact Haristhenics.');
                    return;
                }

                const claim = claimSnap.data();

                // Already claimed by someone else
                if (claim.claimed && claim.claimedBy !== user.uid) {
                    showError('This link has already been used. Contact us if this is a mistake.');
                    return;
                }

                // Expired check (30 days)
                const created = new Date(claim.createdAt);
                const now = new Date();
                const diffDays = (now - created) / (1000 * 60 * 60 * 24);
                if (diffDays > 30) {
                    showError('This link has expired (30 days). Please contact Haristhenics.');
                    return;
                }

                // Email match check (optional but safer)
                if (claim.email && claim.email.toLowerCase() !== user.email.toLowerCase()) {
                    showError('Please sign in with the email used during purchase: ' + claim.email);
                    return;
                }

                // Save purchase to user
                const userRef = doc(db, 'users', user.uid);
                const userSnap = await getDoc(userRef);
                const existing = userSnap.exists() ? (userSnap.data().purchases || []) : [];

                const alreadyOwned = existing.find(p => p.id === claim.courseId);
                if (!alreadyOwned) {
                    await setDoc(userRef, {
                        purchases: [...existing, {
                            id: claim.courseId,
                            name: claim.courseName,
                            url: claim.courseUrl,
                            thumbnail: claim.thumbnail,
                            date: new Date().toLocaleDateString('en-IN'),
                            paymentId: claim.paymentId
                        }]
                    }, { merge: true });
                }

                // Mark token as claimed
                await updateDoc(claimRef, {
                    claimed: true,
                    claimedBy: user.uid,
                    claimedAt: new Date().toISOString()
                });

                showSuccess('Course unlocked! Taking you to your program...');

                setTimeout(() => {
                    window.location.href = claim.courseUrl || '../index.html';
                }, 2000);

            } catch (err) {
                console.error('Claim error:', err);
                showError('Something went wrong. Please try again or contact us.');
            }
        }

        // ==========================================
        // HELPERS
        // ==========================================
        function showError(msg) {
            document.getElementById('alertErrorText').textContent = msg;
            document.getElementById('alertError').classList.add('show');
            document.getElementById('alertSuccess').classList.remove('show');
        }

        function showSuccess(msg) {
            document.getElementById('alertSuccessText').textContent = msg;
            document.getElementById('alertSuccess').classList.add('show');
            document.getElementById('alertError').classList.remove('show');
        }

        window.showError = showError;
        window.showSuccess = showSuccess;

        console.log('✅ Claim page loaded | Token:', token || 'none');
    </script>

</body>
</html>
